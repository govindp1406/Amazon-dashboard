<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Business Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configure Tailwind to use Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        /* Simple style for number inputs */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Simple toast notification style */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show {
            bottom: 30px;
        }
        /* Make modal backdrop visible */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* NEW: Loading Overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            font-size: 1.125rem;
            font-weight: 500;
            color: #374151; /* gray-700 */
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb; /* gray-200 */
            border-top-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- NEW: Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Connecting to database...</p>
    </div>

    <div class="relative min-h-screen md:flex">
        <!-- Mobile Menu Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-6 fixed inset-y-0 left-0 h-full shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-20 flex flex-col">
            <div>
                <h1 class="text-2xl font-bold mb-8">My Dashboard</h1>
                <nav>
                    <!-- Navigation Links -->
                    <a href="#" id="nav-dashboard" class="flex items-center py-2.5 px-4 rounded-lg bg-blue-600 text-white mb-2">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M12 12h.01M15 12h.01M12 15h.01M15 15h.01M9 15h.01"></path></svg>
                        Active Products
                    </a>
                    <a href="#" id="nav-calculator" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 transition duration-200 mb-2">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Profit Calculator
                        <svg class="lock-icon w-4 h-4 ml-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </a>
                    <a href="#" id="nav-inventory" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 transition duration-200 mb-2">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-1v4m0 0H8m4 0h4m-4 8v4m0 0H8m4 0h4m-4-8v4m0 0H8m4 0h4"></path></svg>
                        Inventory
                        <svg class="lock-icon w-4 h-4 ml-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </a>
                    <a href="#" id="nav-revenue" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 transition duration-200 mb-2">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0-8c-1.11 0-2.08.402-2.599 1M12 16v-1m0 1v1m0-1c-1.11 0-2.08-.402-2.599-1M9.401 15c-.519-.598-1.401-1-2.599-1m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3 .895 3 2-1.343 2-3 2m2.599-3c.519.598 1.401 1 2.599 1m0 0c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2m-2.599 3c-.519-.598-1.401-1-2.599-1"></path></svg>
                        Profit
                        <svg class="lock-icon w-4 h-4 ml-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </a>
                    <a href="#" id="nav-expenses" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 transition duration-200 mb-2">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l-1.612-5.642A3 3 0 019 8zm0 6h6m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Expenses
                        <svg class="lock-icon w-4 h-4 ml-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </a>
                    <a href="#" id="nav-analysis" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 transition duration-200">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        Analysis
                        <svg class="lock-icon w-4 h-4 ml-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </a>
                </nav>
            </div>
            <!-- NEW: Lock Button -->
            <div class="mt-auto">
                 <a href="#" id="nav-lock" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 transition duration-200">
                    <svg class="unlock-icon w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                    <span id="lock-button-text">Lock Sections</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-6 md:p-12 overflow-auto">
            <!-- Mobile Header -->
            <header class="md:hidden flex justify-between items-center mb-6">
                <h2 id="mobile-header-title" class="text-2xl font-bold text-gray-800">Active Products</h2>
                <button id="menu-toggle" class="p-2 rounded-md text-gray-600 hover:bg-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </header>

            <!-- ======================= -->
            <!-- Profit Calculator Page  -->
            <!-- ======================= -->
            <div id="page-calculator" class="hidden">
                <!-- ... existing calculator HTML ... -->
                <!-- Desktop Header -->
                <h2 class="hidden md:block text-3xl font-bold text-gray-800 mb-8">Amazon Profit Calculator</h2>
                
                <!-- Calculator Card -->
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="profit-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="selling-price" class="block text-sm font-medium text-gray-700 mb-1">Selling Price</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="selling-price" placeholder="499.00" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required step="0.01">
                                </div>
                            </div>
                            <div>
                                <label for="product-cost" class="block text-sm font-medium text-gray-700 mb-1">Product Cost</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="product-cost" placeholder="150.00" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" step="0.01">
                                </div>
                            </div>
                            <div>
                                <label for="product-weight" class="block text-sm font-medium text-gray-700 mb-1">Product Weight (grams)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">g</span>
                                    <input type="number" id="product-weight" placeholder="e.g., 450" class="w-full pr-8 pl-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label for="shipping-cost" class="block text-sm font-medium text-gray-700 mb-1">Shipping Cost</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="shipping-cost" placeholder="Calculated from weight" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-300 focus:border-transparent bg-gray-100" readonly>
                                </div>
                            </div>
                            <div>
                                <label for="packaging-cost" class="block text-sm font-medium text-gray-700 mb-1">Packaging Cost</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="packaging-cost" placeholder="10.00" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" step="0.01">
                                </div>
                            </div>
                            <div>
                                <label for="amazon-fees" class="block text-sm font-medium text-gray-700 mb-1">Amazon Fees</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="amazon-fees" placeholder="75.00" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" step="0.01">
                                </div>
                            </div>
                            <div>
                                <label for="gst-percentage" class="block text-sm font-medium text-gray-700 mb-1">GST (%)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">%</span>
                                    <input type="number" id="gst-percentage" placeholder="18" class="w-full pr-7 pl-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" step="1">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="other-costs" class="block text-sm font-medium text-gray-700 mb-1">Other Costs (Ads, etc)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="other-costs" placeholder="20.00" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                Calculate Profit
                            </button>
                        </div>
                    </form>
                    <div id="results-container" class="mt-8 pt-6 border-t border-gray-200 hidden">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Calculation Results</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                                <span class="text-lg font-medium text-gray-600">Total Cost:</span>
                                <span id="total-cost" class="text-lg font-bold text-gray-800">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center bg-blue-50 p-4 rounded-lg">
                                <span class="text-lg font-medium text-blue-700">Profit Margin (Before Tax):</span>
                                <span id="profit-margin" class="text-lg font-bold text-blue-700">0.00%</span>
                            </div>
                            <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                                <span class="text-lg font-medium text-gray-600">Profit Before Tax:</span>
                                <span id="net-profit-before-tax" class="text-lg font-bold text-gray-800">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center bg-red-50 p-4 rounded-lg">
                                <span class="text-lg font-medium text-red-700">Tax Amount (GST):</span>
                                <span id="tax-amount" class="text-lg font-bold text-red-700">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center bg-green-50 p-4 rounded-lg">
                                <span class="text-lg font-medium text-green-700">Net Profit (After Tax):</span>
                                <span id="net-profit-after-tax" class="text-2xl font-bold text-green-700">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center bg-blue-50 p-4 rounded-lg">
                                <span class="text-lg font-medium text-blue-700">Return on Investment (ROI):</span>
                                <span id="roi" class="text-2xl font-bold text-blue-700">0.00%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================= -->
            <!-- Dashboard Page -->
            <!-- ======================= -->
            <div id="page-dashboard">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8">
                    <h2 class="hidden md:block text-3xl font-bold text-gray-800">Active Products</h2>
                    <button id="add-product-btn" class="w-full md:w-auto bg-blue-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 mt-4 md:mt-0">
                        + Add New Product
                    </button>
                </div>
                <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Product cards will be inserted here dynamically -->
                    <p id="no-products-message" class="text-gray-500">No products found. Add a new product to get started.</p>
                </div>
            </div>

            <!-- ============================= -->
            <!-- Inventory Management Page     -->
            <!-- ============================= -->
            <div id="page-inventory" class="hidden">
                <div class="mb-8">
                    <h2 class="hidden md:block text-3xl font-bold text-gray-800">Inventory Management</h2>
                </div>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Update Daily Stock</h3>
                    <form id="inventory-form">
                        <div class="space-y-6">
                            <div>
                                <label for="inventory-product-select" class="block text-sm font-medium text-gray-700 mb-1">Select Product</label>
                                <select id="inventory-product-select" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" required>
                                    <!-- Product options will be inserted here dynamically -->
                                </select>
                            </div>
                            <div>
                                <label for="inventory-daily-orders" class="block text-sm font-medium text-gray-700 mb-1">Daily Orders Placed</label>
                                <input type="number" id="inventory-daily-orders" placeholder="e.g., 15" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required min="0">
                            </div>
                        </div>
                        <div class="mt-8">
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                Update Stock
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ============================= -->
            <!-- Revenue Page (Profit Page)    -->
            <!-- ============================= -->
            <div id="page-revenue" class="hidden">
                <h2 class="hidden md:block text-3xl font-bold text-gray-800 mb-8">Profit Tracking</h2>
                
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-lg mx-auto mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Set Product Profits</h3>
                    <form id="profit-set-form">
                        <div class="space-y-6">
                            <div>
                                <label for="profit-product-select" class="block text-sm font-medium text-gray-700 mb-1">Select Product</label>
                                <select id="profit-product-select" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" required>
                                    <!-- Product options will be inserted here dynamically -->
                                </select>
                            </div>
                            <div>
                                <label for="profit-per-unit-input" class="block text-sm font-medium text-gray-700 mb-1">Profit Per Unit</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="profit-per-unit-input" placeholder="25.00" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                Save Profit
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg w-full mx-auto mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="revenue-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="revenue-start-date" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="revenue-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="revenue-end-date" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button id="revenue-filter-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Apply Filter
                        </button>
                        <button id="revenue-clear-filter-btn" class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                            Clear Filter
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md mx-auto md:max-w-none mb-6">
                    <div class="flex justify-between items-center">
                        <span id="profit-total-label" class="text-lg font-medium text-gray-600">Total Gross Profit (All Time):</span>
                        <span id="profit-total-display" class="text-3xl font-bold text-blue-600">₹0.00</span>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Profit History</h3>
                <div class="w-full bg-white shadow-md rounded-xl overflow-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Date & Time</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Product</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Qty Sold</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Profit (per unit)</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Total Profit</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-table-body" class="divide-y divide-gray-200">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full mx-auto mt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Profit Contribution (in range)</h3>
                    <div class="relative h-64 md:h-96">
                        <canvas id="revenue-pie-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ============================= -->
            <!-- Expenses Page -->
            <!-- ============================= -->
            <div id="page-expenses" class="hidden">
                <h2 class="hidden md:block text-3xl font-bold text-gray-800 mb-8">Expenses</h2>

                <div class="bg-white p-6 rounded-xl shadow-lg w-full mx-auto mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="expenses-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="expenses-start-date" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="expenses-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="expenses-end-date" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button id="expenses-filter-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Apply Filter
                        </button>
                        <button id="expenses-clear-filter-btn" class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                            Clear Filter
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md mx-auto md:max-w-none mb-6">
                    <div class="flex justify-between items-center">
                        <span id="expenses-total-label" class="text-lg font-medium text-gray-600">Total Expenses (All Time):</span>
                        <span id="expenses-total-display" class="text-3xl font-bold text-red-600">₹0.00</span>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-lg mx-auto mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Log a New Expense</h3>
                    <form id="expenses-form">
                        <div class="space-y-6">
                            <div>
                                <label for="expenses-product-name" class="block text-sm font-medium text-gray-700 mb-1">Product / Service Name</label>
                                <input type="text" id="expenses-product-name" placeholder="e.g., Bubble Wrap, Tape, etc." class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="expenses-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity (optional)</label>
                                <input type="number" id="expenses-quantity" placeholder="e.g., 50" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="0">
                            </div>
                            <div>
                                <label for="expenses-total-price" class="block text-sm font-medium text-gray-700 mb-1">Total Purchase Price</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                    <input type="number" id="expenses-total-price" placeholder="500.00" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                Log Expense
                            </button>
                        </div>
                    </form>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Expense History</h3>
                <div class="w-full bg-white shadow-md rounded-xl overflow-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Date & Time</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Product/Service</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Quantity</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Total Price</th>
                                <th class="text-left py-3 px-4 sm:px-6 text-sm font-semibold text-gray-600 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table-body" class="divide-y divide-gray-200">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- ============================= -->
            <!-- Analysis Page -->
            <!-- ============================= -->
            <div id="page-analysis" class="hidden">
                <h2 class="hidden md:block text-3xl font-bold text-gray-800 mb-8">Sales Analysis</h2>

                <div class="bg-white p-6 rounded-xl shadow-lg w-full mx-auto mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="analysis-product-select" class="block text-sm font-medium text-gray-700 mb-1">Select Product (for Line Chart)</label>
                            <select id="analysis-product-select" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" required>
                                <!-- Product options will be inserted here dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="analysis-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="analysis-start-date" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="analysis-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="analysis-end-date" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button id="analysis-filter-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Apply Filter
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-xs mx-auto md:mx-0 md:max-w-none mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-medium text-gray-600">Total Units Sold (Selected Product):</span>
                        <span id="analysis-total-sold" class="text-3xl font-bold text-blue-600">0 units</span>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full mx-auto">
                    <div class="relative h-64 md:h-96">
                        <canvas id="sales-chart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full mx-auto mt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Total Sales Contribution (in range)</h3>
                    <div class="relative h-64 md:h-96">
                        <canvas id="sales-pie-chart"></canvas>
                    </div>
                </div>
            </div>


        </main>
        
        <!-- ================================== -->
        <!-- Add/Edit Product Modal -->
        <!-- ================================== -->
        <div id="product-modal" class="fixed inset-0 modal-backdrop z-40 hidden flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                <h3 id="product-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Add New Product</h3>
                <form id="product-form">
                    <div class="space-y-4">
                        <div>
                            <label for="modal-product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                            <input type="text" id="modal-product-name" placeholder="e.g., Jowar Poha" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label for="modal-product-sku" class="block text-sm font-medium text-gray-700 mb-1">SKU (Stock Keeping Unit)</label>
                            <input type="text" id="modal-product-sku" placeholder="e.g., JP-500G" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label for="modal-product-stock" class="block text-sm font-medium text-gray-700 mb-1">Current Stock</label>
                            <input type="number" id="modal-product-stock" placeholder="100" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required min="0">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="modal-cancel-btn" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                            Cancel
                        </button>
                        <button type="submit" id="modal-save-btn" class="w-full md:w-auto bg-blue-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Save Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ============================= -->
        <!-- Edit Expense Modal -->
        <!-- ============================= -->
        <div id="edit-expense-modal" class="fixed inset-0 modal-backdrop z-40 hidden flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Edit Expense</h3>
                <form id="edit-expense-form">
                    <div class="space-y-4">
                        <div>
                            <label for="edit-expense-product-name" class="block text-sm font-medium text-gray-700 mb-1">Product / Service Name</label>
                            <input type="text" id="edit-expense-product-name" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label for="edit-expense-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity (optional)</label>
                            <input type="number" id="edit-expense-quantity" class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="0">
                        </div>
                        <div>
                            <label for="edit-expense-total-price" class="block text-sm font-medium text-gray-700 mb-1">Total Purchase Price</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                <input type="number" id="edit-expense-total-price" class="w-full pl-7 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="edit-expense-cancel-btn" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ============================= -->
        <!-- Confirmation Modal -->
        <!-- ============================= -->
        <div id="confirmation-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Are you sure?</h3>
                <p id="confirmation-message" class="text-gray-600 mb-6">You will not be able to recover this item.</p>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="confirmation-cancel-btn" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                        Cancel
                    </button>
                    <button type="button" id="confirmation-confirm-btn" class="bg-red-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================= -->
        <!-- NEW: PIN Lock Modal           -->
        <!-- ============================= -->
        <div id="pin-lock-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Enter PIN</h3>
                <p class="text-center text-gray-500 mb-6">Enter the 4-digit PIN to unlock all sections.</p>
                <form id="pin-form">
                    <div>
                        <label for="pin-input" class="sr-only">PIN</label>
                        <input type="password" id="pin-input" name="pin" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="w-full text-center text-3xl tracking-widest font-bold py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <p id="pin-error-message" class="text-red-500 text-sm text-center mt-2 h-4"></p>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="pin-cancel-btn" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Unlock
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="bg-green-600 text-white">
            Stock updated successfully!
        </div>

    </div>

    <!-- ============================= -->
    <!-- NEW: FIREBASE SCRIPT          -->
    <!-- ============================= -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            serverTimestamp,
            arrayUnion,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase State ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // --- Global App State (now populated by Firebase) ---
        let products = []; // Local cache of products
        let expenses = []; // Local cache of expenses
        
        // --- NEW: Lock State ---
        let isUnlocked = false;
        let targetPage = null; // Page to go to after unlock
        
        // --- Firestore Collection References ---
        let productsCollection, expensesCollection;

        // --- Global Chart Variables ---
        let salesChartInstance = null;
        let salesPieChartInstance = null;
        let revenuePieChartInstance = null;
        
        // --- Global State for Modals ---
        let currentEditProductId = null; // Use Firestore doc ID
        let currentEditExpenseId = null; // Use Firestore doc ID
        let confirmCallback = null;

        // --- Element Selectors ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileHeaderTitle = document.getElementById('mobile-header-title');

        // Page Navigation
        const navCalculator = document.getElementById('nav-calculator');
        const navDashboard = document.getElementById('nav-dashboard');
        const navInventory = document.getElementById('nav-inventory');
        const navRevenue = document.getElementById('nav-revenue'); 
        const navExpenses = document.getElementById('nav-expenses'); 
        const navAnalysis = document.getElementById('nav-analysis');
        const navLock = document.getElementById('nav-lock'); // NEW
        const lockIcons = document.querySelectorAll('.lock-icon'); // NEW
        const lockButtonText = document.getElementById('lock-button-text'); // NEW
        const unlockIcon = document.querySelector('.unlock-icon'); // NEW
        
        const pageCalculator = document.getElementById('page-calculator');
        const pageDashboard = document.getElementById('page-dashboard');
        const pageInventory = document.getElementById('page-inventory');
        const pageRevenue = document.getElementById('page-revenue'); 
        const pageExpenses = document.getElementById('page-expenses'); 
        const pageAnalysis = document.getElementById('page-analysis');
        
        // Add/Edit Product Modal
        const productModal = document.getElementById('product-modal');
        const addProductBtn = document.getElementById('add-product-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const productForm = document.getElementById('product-form');
        const productModalTitle = document.getElementById('product-modal-title');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductSku = document.getElementById('modal-product-sku');
        const modalProductStock = document.getElementById('modal-product-stock');

        // Dashboard Page
        const productGrid = document.getElementById('product-grid');
        const noProductsMessage = document.getElementById('no-products-message');

        // Inventory Page
        const inventoryForm = document.getElementById('inventory-form');
        const inventoryProductSelect = document.getElementById('inventory-product-select');
        const inventoryDailyOrders = document.getElementById('inventory-daily-orders');
        const toast = document.getElementById('toast');
        
        // Revenue (Profit) Page
        const profitSetForm = document.getElementById('profit-set-form');
        const profitProductSelect = document.getElementById('profit-product-select');
        const profitPerUnitInput = document.getElementById('profit-per-unit-input');
        const revenueStartDate = document.getElementById('revenue-start-date');
        const revenueEndDate = document.getElementById('revenue-end-date');
        const revenueFilterBtn = document.getElementById('revenue-filter-btn');
        const revenueClearFilterBtn = document.getElementById('revenue-clear-filter-btn');
        const profitTotalLabel = document.getElementById('profit-total-label');
        const profitTotalDisplay = document.getElementById('profit-total-display');
        const revenueTableBody = document.getElementById('revenue-table-body');
        const revenuePieChartCanvas = document.getElementById('revenue-pie-chart');

        // Expenses Page
        const expensesForm = document.getElementById('expenses-form');
        const expensesProductName = document.getElementById('expenses-product-name');
        const expensesQuantity = document.getElementById('expenses-quantity');
        const expensesTotalPrice = document.getElementById('expenses-total-price');
        const expensesTotalDisplay = document.getElementById('expenses-total-display');
        const expensesTableBody = document.getElementById('expenses-table-body');
        const expensesStartDate = document.getElementById('expenses-start-date');
        const expensesEndDate = document.getElementById('expenses-end-date');
        const expensesFilterBtn = document.getElementById('expenses-filter-btn');
        const expensesClearFilterBtn = document.getElementById('expenses-clear-filter-btn');
        const expensesTotalLabel = document.getElementById('expenses-total-label');
                
        // Edit Expense Modal
        const editExpenseModal = document.getElementById('edit-expense-modal');
        const editExpenseForm = document.getElementById('edit-expense-form');
        const editExpenseCancelBtn = document.getElementById('edit-expense-cancel-btn');
        const editExpenseProductName = document.getElementById('edit-expense-product-name');
        const editExpenseQuantity = document.getElementById('edit-expense-quantity');
        const editExpenseTotalPrice = document.getElementById('edit-expense-total-price');

        // Confirmation Modal
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmationCancelBtn = document.getElementById('confirmation-cancel-btn');
        const confirmationConfirmBtn = document.getElementById('confirmation-confirm-btn');

        // NEW: PIN Lock Modal
        const pinLockModal = document.getElementById('pin-lock-modal');
        const pinForm = document.getElementById('pin-form');
        const pinInput = document.getElementById('pin-input');
        const pinCancelBtn = document.getElementById('pin-cancel-btn');
        const pinErrorMessage = document.getElementById('pin-error-message');

        // Analysis Page
        const analysisProductSelect = document.getElementById('analysis-product-select');
        const salesChartCanvas = document.getElementById('sales-chart');
        const salesPieChartCanvas = document.getElementById('sales-pie-chart'); 
        const analysisStartDate = document.getElementById('analysis-start-date');
        const analysisEndDate = document.getElementById('analysis-end-date');
        const analysisFilterBtn = document.getElementById('analysis-filter-btn');
        const analysisTotalSold = document.getElementById('analysis-total-sold');

        // Calculator Page
        const calculatorForm = document.getElementById('profit-form');
        const productWeightEl = document.getElementById('product-weight');
        const shippingCostEl = document.getElementById('shipping-cost');


        // --- Mobile Sidebar Toggle ---
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }
        menuToggle.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        // --- Page Navigation Logic ---
        function setActivePage(pageName) {
            // Hide all pages
            pageCalculator.classList.add('hidden');
            pageDashboard.classList.add('hidden');
            pageInventory.classList.add('hidden');
            pageRevenue.classList.add('hidden'); 
            pageExpenses.classList.add('hidden'); 
            pageAnalysis.classList.add('hidden');

            // Remove active style from all nav links
            navCalculator.classList.remove('bg-blue-600', 'text-white');
            navCalculator.classList.add('hover:bg-gray-700');
            navDashboard.classList.remove('bg-blue-600', 'text-white');
            navDashboard.classList.add('hover:bg-gray-700');
            navInventory.classList.remove('bg-blue-600', 'text-white');
            navInventory.classList.add('hover:bg-gray-700');
            navRevenue.classList.remove('bg-blue-600', 'text-white'); 
            navRevenue.classList.add('hover:bg-gray-700'); 
            navExpenses.classList.remove('bg-blue-600', 'text-white'); 
            navExpenses.classList.add('hover:bg-gray-700'); 
            navAnalysis.classList.remove('bg-blue-600', 'text-white');
            navAnalysis.classList.add('hover:bg-gray-700');
            
            // Show the active page and set nav style
            if (pageName === 'calculator') {
                pageCalculator.classList.remove('hidden');
                navCalculator.classList.add('bg-blue-600', 'text-white');
                navCalculator.classList.remove('hover:bg-gray-700');
                mobileHeaderTitle.textContent = 'Profit Calculator';
            } else if (pageName === 'dashboard') {
                pageDashboard.classList.remove('hidden');
                navDashboard.classList.add('bg-blue-600', 'text-white');
                navDashboard.classList.remove('hover:bg-gray-700');
                mobileHeaderTitle.textContent = 'Active Products';
                renderDashboard(); // Re-render in case data changed
            } else if (pageName === 'inventory') {
                pageInventory.classList.remove('hidden');
                navInventory.classList.add('bg-blue-600', 'text-white');
                navInventory.classList.remove('hover:bg-gray-700');
                mobileHeaderTitle.textContent = 'Inventory';
                populateInventoryDropdown(); // Refresh dropdown
            } else if (pageName === 'revenue') { 
                pageRevenue.classList.remove('hidden');
                navRevenue.classList.add('bg-blue-600', 'text-white');
                navRevenue.classList.remove('hover:bg-gray-700');
                mobileHeaderTitle.textContent = 'Profit Tracking';
                revenueStartDate.value = '';
                revenueEndDate.value = '';
                populateProfitSetDropdown(); 
                renderRevenuePage();
            } else if (pageName === 'expenses') { 
                pageExpenses.classList.remove('hidden');
                navExpenses.classList.add('bg-blue-600', 'text-white');
                navExpenses.classList.remove('hover:bg-gray-700');
                mobileHeaderTitle.textContent = 'Expenses';
                expensesStartDate.value = '';
                expensesEndDate.value = '';
                renderExpensesPage(); 
            } else if (pageName === 'analysis') {
                pageAnalysis.classList.remove('hidden');
                navAnalysis.classList.add('bg-blue-600', 'text-white');
                navAnalysis.classList.remove('hover:bg-gray-700');
                mobileHeaderTitle.textContent = 'Analysis';
                
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                analysisEndDate.value = today.toISOString().split('T')[0];
                analysisStartDate.value = thirtyDaysAgo.toISOString().split('T')[0];

                populateAnalysisDropdown();
                updateAnalysis();
            }

            // Close sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        }
        
        // --- NEW: PIN Lock Logic ---
        
        function openPinModal(page) {
            targetPage = page;
            pinInput.value = '';
            pinErrorMessage.textContent = '';
            pinLockModal.classList.remove('hidden');
            pinLockModal.classList.add('flex');
            pinInput.focus();
        }

        function closePinModal() {
            pinLockModal.classList.add('hidden');
            pinLockModal.classList.remove('flex');
            targetPage = null;
        }
        
        function updateLockIcons() {
            if (isUnlocked) {
                lockIcons.forEach(icon => icon.classList.add('hidden'));
                lockButtonText.textContent = 'Lock Sections';
                // Change icon to 'unlocked'
                unlockIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>`;
            } else {
                lockIcons.forEach(icon => icon.classList.remove('hidden'));
                lockButtonText.textContent = 'Unlock Sections';
                // Change icon to 'locked'
                unlockIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>`;
            }
        }

        pinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (pinInput.value === '1406') {
                isUnlocked = true;
                showToast('Sections Unlocked!', 'success');
                closePinModal();
                updateLockIcons();
                if (targetPage) {
                    setActivePage(targetPage);
                }
            } else {
                pinErrorMessage.textContent = 'Incorrect PIN. Please try again.';
                pinInput.value = '';
                pinInput.focus();
            }
        });
        
        pinCancelBtn.addEventListener('click', closePinModal);
        
        navLock.addEventListener('click', (e) => {
            e.preventDefault();
            if (isUnlocked) {
                isUnlocked = false;
                showToast('Sections Locked.', 'success');
                setActivePage('dashboard');
            } else {
                openPinModal(null); // Just open PIN modal, no target page
            }
            updateLockIcons();
        });

        // --- UPDATED: Navigation Listeners with PIN Check ---
        navCalculator.addEventListener('click', (e) => { 
            e.preventDefault(); 
            if (isUnlocked) {
                setActivePage('calculator'); 
            } else {
                openPinModal('calculator');
            }
        });
        navDashboard.addEventListener('click', (e) => { 
            e.preventDefault(); 
            setActivePage('dashboard'); 
        }); // Dashboard is always unlocked
        navInventory.addEventListener('click', (e) => { 
            e.preventDefault(); 
            if (isUnlocked) {
                setActivePage('inventory'); 
            } else {
                openPinModal('inventory');
            }
        });
        navRevenue.addEventListener('click', (e) => { 
            e.preventDefault(); 
            if (isUnlocked) {
                setActivePage('revenue'); 
            } else {
                openPinModal('revenue');
            }
        }); 
        navExpenses.addEventListener('click', (e) => { 
            e.preventDefault(); 
            if (isUnlocked) {
                setActivePage('expenses'); 
            } else {
                openPinModal('expenses');
            }
        }); 
        navAnalysis.addEventListener('click', (e) => { 
            e.preventDefault(); 
            if (isUnlocked) {
                setActivePage('analysis'); 
            } else {
                openPinModal('analysis');
            }
        });
        
        // --- Analysis Page Listeners ---
        analysisProductSelect.addEventListener('change', updateAnalysis);
        analysisFilterBtn.addEventListener('click', updateAnalysis);
        
        // --- Expenses Page Listeners ---
        expensesFilterBtn.addEventListener('click', renderExpensesPage);
        expensesClearFilterBtn.addEventListener('click', () => {
            expensesStartDate.value = '';
            expensesEndDate.value = '';
            renderExpensesPage();
        });
        
        // --- Revenue Page Listeners ---
        revenueFilterBtn.addEventListener('click', renderRevenuePage);
        revenueClearFilterBtn.addEventListener('click', () => {
            revenueStartDate.value = '';
            revenueEndDate.value = '';
            renderRevenuePage();
        });
        
        
        // --- Add/Edit Product Modal Logic (UPDATED FOR FIREBASE) ---
        
        function openAddProductModal() {
            // NEW: PIN Check
            if (!isUnlocked) {
                openPinModal(null); // Just open PIN modal
                showToast('Please unlock to add products.', 'error');
                return;
            }
            currentEditProductId = null; 
            productForm.reset();
            productModalTitle.textContent = 'Add New Product';
            modalSaveBtn.textContent = 'Save Product';
            modalProductSku.readOnly = false;
            modalProductSku.classList.remove('bg-gray-100');
            productModal.classList.remove('hidden');
            productModal.classList.add('flex');
        }

        function openEditProductModal(productId) {
            // NEW: PIN Check
            if (!isUnlocked) {
                openPinModal(null); // Just open PIN modal
                showToast('Please unlock to edit products.', 'error');
                return;
            }
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            currentEditProductId = productId; 
            productForm.reset();
            productModalTitle.textContent = 'Edit Product';
            modalSaveBtn.textContent = 'Save Changes';
            
            modalProductName.value = product.name;
            modalProductSku.value = product.sku;
            modalProductStock.value = product.stock;
            
            modalProductSku.readOnly = true; 
            modalProductSku.classList.add('bg-gray-100');
            
            productModal.classList.remove('hidden');
            productModal.classList.add('flex');
        }

        function closeProductModal() {
            currentEditProductId = null;
            productForm.reset();
            productModal.classList.add('hidden');
            productModal.classList.remove('flex');
        }

        addProductBtn.addEventListener('click', openAddProductModal);
        modalCancelBtn.addEventListener('click', closeProductModal);
        productModal.addEventListener('click', function(e) {
            if (e.target === productModal) closeProductModal();
        });

        // Handle Add/Edit Product Form Submission
        productForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newName = modalProductName.value;
            const newSku = modalProductSku.value;
            const newStock = parseInt(modalProductStock.value) || 0;

            // Show loading on button
            modalSaveBtn.disabled = true;
            modalSaveBtn.textContent = 'Saving...';

            try {
                if (currentEditProductId) {
                    // --- EDIT MODE ---
                    const productRef = doc(productsCollection, currentEditProductId);
                    await updateDoc(productRef, {
                        name: newName,
                        stock: newStock
                    });
                    showToast('Product updated successfully!', 'success');
                } else {
                    // --- ADD MODE ---
                    // Check for duplicate SKU
                    const q = query(productsCollection, where("sku", "==", newSku));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        showToast('SKU already exists. Please use a unique SKU.', 'error');
                        return;
                    }

                    const newProduct = { 
                        name: newName, 
                        sku: newSku, 
                        stock: newStock, 
                        profitPerUnit: 0, 
                        salesHistory: [],
                        createdAt: serverTimestamp()
                    };
                    await addDoc(productsCollection, newProduct);
                    showToast('Product added successfully!', 'success');
                }
                closeProductModal();
            } catch (error) {
                console.error("Error saving product: ", error);
                showToast('Error saving product. Check console.', 'error');
            } finally {
                // Restore button
                modalSaveBtn.disabled = false;
                modalSaveBtn.textContent = currentEditProductId ? 'Save Changes' : 'Save Product';
            }
        });


        // --- Sales Calculation Helper (NO CHANGE) ---
        function calculateTotalSales(product, days) {
            const dateLimit = new Date();
            dateLimit.setDate(dateLimit.getDate() - days);
            
            const recentSales = product.salesHistory.filter(entry => {
                const entryDate = entry.dateTime ? new Date(entry.dateTime.toDate()) : new Date(entry.date); // Handle old vs new format
                return entryDate >= dateLimit;
            });
            const total = recentSales.reduce((sum, entry) => sum + entry.quantity, 0);
            return total;
        }

        // --- Dashboard Rendering (UPDATED FOR FIREBASE) ---
        function renderDashboard() {
            productGrid.innerHTML = ''; 

            if (products.length === 0) {
                noProductsMessage.classList.remove('hidden');
            } else {
                noProductsMessage.classList.add('hidden');
                const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedProducts.forEach(product => {
                    const sales30d = calculateTotalSales(product, 30);

                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-xl shadow-lg flex flex-col';
                    card.innerHTML = `
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">${product.name}</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Current Stock:</span>
                                    <span class="text-lg font-bold text-gray-800">${product.stock}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Sales (30d):</span>
                                    <span class="text-lg font-bold text-gray-800">${sales30d}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">SKU:</span>
                                    <span class="text-sm font-mono text-gray-600">${product.sku}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 flex space-x-2">
                            <button class="edit-product-btn w-full text-sm bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-semibold hover:bg-gray-200" data-id="${product.id}">
                                Edit
                            </button>
                            <button class="delete-product-btn w-full text-sm bg-red-100 text-red-700 py-2 px-3 rounded-lg font-semibold hover:bg-red-200" data-id="${product.id}">
                                Delete
                            </button>
                        </div>
                    `;
                    productGrid.appendChild(card);
                });
            }
        }
        
        productGrid.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-product-btn');
            const deleteBtn = e.target.closest('.delete-product-btn');

            if (editBtn) {
                // PIN check is inside openEditProductModal
                const id = editBtn.dataset.id;
                openEditProductModal(id);
            }

            if (deleteBtn) {
                // NEW: PIN Check
                if (!isUnlocked) {
                    openPinModal(null); // Just open PIN modal
                    showToast('Please unlock to delete products.', 'error');
                    return;
                }
                const id = deleteBtn.dataset.id;
                const product = products.find(p => p.id === id);
                if (product) {
                    showConfirmationModal(
                        `Are you sure you want to delete "${product.name}"? This action cannot be undone.`,
                        () => deleteProduct(id)
                    );
                }
            }
        });
        
        async function deleteProduct(id) {
            try {
                await deleteDoc(doc(productsCollection, id));
                showToast('Product deleted successfully.', 'success');
                // No need to re-render, onSnapshot will handle it.
            } catch (error) {
                console.error("Error deleting product: ", error);
                showToast('Error deleting product.', 'error');
            } finally {
                hideConfirmationModal();
            }
        }


        // --- Inventory Page Logic (UPDATED FOR FIREBASE) ---
        function populateInventoryDropdown() {
            inventoryProductSelect.innerHTML = ''; 
            const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));

            if (sortedProducts.length === 0) {
                inventoryProductSelect.innerHTML = '<option disabled selected>No products available</option>';
            } else {
                inventoryProductSelect.innerHTML = '<option value="" disabled selected>Choose a product</option>';
                sortedProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id; // Use Firestore doc ID
                    option.textContent = `${product.name} (SKU: ${product.sku})`;
                    inventoryProductSelect.appendChild(option);
                });
            }
        }

        inventoryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedProductId = inventoryProductSelect.value;
            const dailyOrders = parseInt(inventoryDailyOrders.value) || 0;

            if (!selectedProductId) {
                showToast('Please select a product.', 'error');
                return;
            }
            if (dailyOrders <= 0) {
                showToast('Please enter a valid number of orders.', 'error');
                return;
            }

            const product = products.find(p => p.id === selectedProductId);

            if (product) {
                if (product.stock < dailyOrders) {
                    showToast(`Cannot fulfill ${dailyOrders} orders. Only ${product.stock} in stock.`, 'error');
                    return;
                }

                // Create the new sales entry
                const newSaleEntry = {
                    dateTime: new Date(), // Use JS Date, Firestore converts to Timestamp
                    quantity: dailyOrders,
                    profitAtTimeOfSale: product.profitPerUnit || 0
                };

                const productRef = doc(productsCollection, selectedProductId);

                try {
                    // Update stock and sales history in one go
                    await updateDoc(productRef, {
                        stock: increment(-dailyOrders), // Atomically decrease stock
                        salesHistory: arrayUnion(newSaleEntry) // Add to the sales array
                    });

                    inventoryForm.reset();
                    inventoryProductSelect.value = "";
                    showToast('Stock updated successfully!', 'success');
                    // No need to re-render, onSnapshot will handle it.
                } catch (error) {
                    console.error("Error updating stock: ", error);
                    showToast('Error updating stock. Check console.', 'error');
                }

            } else {
                showToast('Error: Could not find product.', 'error');
            }
        });
        
        // --- Revenue Page Logic (UPDATED FOR FIREBASE) ---
        
        function populateProfitSetDropdown() {
            profitProductSelect.innerHTML = ''; 
            const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));

            if (sortedProducts.length === 0) {
                profitProductSelect.innerHTML = '<option disabled selected>No products available</option>';
            } else {
                profitProductSelect.innerHTML = '<option value="" disabled selected>Choose a product</option>';
                sortedProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (SKU: ${product.sku})`;
                    profitProductSelect.appendChild(option);
                });
            }
            profitPerUnitInput.value = '';
        }

        profitProductSelect.addEventListener('change', function() {
            const selectedProductId = profitProductSelect.value;
            const product = products.find(p => p.id === selectedProductId);
            if (product) {
                profitPerUnitInput.value = (product.profitPerUnit || 0).toFixed(2);
            }
        });

        profitSetForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedProductId = profitProductSelect.value;
            const profitPerUnit = parseFloat(profitPerUnitInput.value) || 0;

            if (!selectedProductId) {
                showToast('Please select a product.', 'error');
                return;
            }
            if (profitPerUnit < 0) {
                showToast('Profit cannot be negative.', 'error');
                return;
            }

            const product = products.find(p => p.id === selectedProductId);
            if (product) {
                try {
                    const productRef = doc(productsCollection, selectedProductId);
                    await updateDoc(productRef, {
                        profitPerUnit: profitPerUnit
                    });
                    showToast(`Profit for ${product.name} updated!`, 'success');
                    // No need to re-render, onSnapshot handles it.
                } catch (error) {
                    console.error("Error updating profit: ", error);
                    showToast('Error updating profit.', 'error');
                }
            }
        });


        function renderRevenuePage() {
            revenueTableBody.innerHTML = '';
            let overallTotalProfit = 0;

            const startDate = revenueStartDate.value;
            const endDate = revenueEndDate.value;

            let allSales = [];
            products.forEach(product => {
                product.salesHistory.forEach(sale => {
                    const saleDate = sale.dateTime.toDate(); // Convert Firestore Timestamp to JS Date
                    const saleDateString = saleDate.toISOString().split('T')[0];

                    // Filter by date
                    if (startDate && saleDateString < startDate) return;
                    if (endDate && saleDateString > endDate) return;

                    const profitPerUnit = sale.profitAtTimeOfSale || 0; // Use historical profit
                    const totalProfit = sale.quantity * profitPerUnit;
                    
                    allSales.push({
                        dateTime: saleDate, // Already a JS Date
                        productName: product.name,
                        quantity: sale.quantity,
                        profitPerUnit: profitPerUnit,
                        totalProfit: totalProfit
                    });

                    overallTotalProfit += totalProfit;
                });
            });
            
            allSales.sort((a, b) => b.dateTime - a.dateTime); // Sort by date (newest first)
            
            const dateRangeLabel = (startDate || endDate) ? 'Filtered' : 'All Time';
            profitTotalLabel.textContent = `Total Gross Profit (${dateRangeLabel}):`;

            if (allSales.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="text-center p-6 text-gray-500">${(startDate || endDate) ? 'No sales found for this date range.' : 'No sales logged yet.'}</td>`;
                revenueTableBody.appendChild(tr);
            } else {
                allSales.forEach(sale => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';

                    const dateString = sale.dateTime.toLocaleDateString('en-IN', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });
                    const timeString = sale.dateTime.toLocaleTimeString('en-IN', {
                        hour: '2-digit', minute: '2-digit', hour12: true
                    });

                    tr.innerHTML = `
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-700">
                            <div>${dateString}</div>
                            <div class="text-xs text-gray-500">${timeString}</div>
                        </td>
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-900 font-medium">${sale.productName}</td>
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-700">${sale.quantity}</td>
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-700">₹${sale.profitPerUnit.toFixed(2)}</td>
                        <td class="py-4 px-4 sm:px-6 text-sm text-blue-700 font-semibold">₹${sale.totalProfit.toFixed(2)}</td>
                    `;
                    revenueTableBody.appendChild(tr);
                });
            }
            
            profitTotalDisplay.textContent = `₹${overallTotalProfit.toFixed(2)}`;
            renderRevenuePieChart(startDate, endDate);
        }

        function renderRevenuePieChart(startDate, endDate) {
            if (revenuePieChartInstance) {
                revenuePieChartInstance.destroy();
            }

            const profitByProduct = products.map(product => {
                const total = product.salesHistory
                    .filter(sale => {
                        const saleDate = sale.dateTime.toDate().toISOString().split('T')[0];
                        if (startDate && saleDate < startDate) return false;
                        if (endDate && saleDate > endDate) return false;
                        return true;
                    })
                    .reduce((sum, sale) => sum + (sale.quantity * (sale.profitAtTimeOfSale || 0)), 0);
                
                return { name: product.name, total: total };
            }).filter(p => p.total > 0); 
            
            const ctx = revenuePieChartCanvas.getContext('2d');
            if (profitByProduct.length === 0) {
                ctx.clearRect(0, 0, revenuePieChartCanvas.width, revenuePieChartCanvas.height);
                ctx.save();
                ctx.textAlign = 'center';
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.fillText('No profit data for any product in this range.', revenuePieChartCanvas.width / 2, revenuePieChartCanvas.height / 2);
                ctx.restore();
                return;
            }

            const labels = profitByProduct.map(p => p.name);
            const data = profitByProduct.map(p => p.total);
            const colors = labels.map((_, i) => `hsl(${(i * 360 / labels.length) % 360}, 70%, 60%)`);

            revenuePieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Profit',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${label}: ₹${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
 
        // --- Expenses Page Logic (UPDATED FOR FIREBASE) ---
    
        function renderExpensesPage() {
            expensesTableBody.innerHTML = ''; 
            let overallTotal = 0;

            const startDate = expensesStartDate.value;
            const endDate = expensesEndDate.value;

            let filteredExpenses = expenses.filter(expense => {
                const expenseDate = expense.dateTime.toDate().toISOString().split('T')[0];
                if (startDate && expenseDate < startDate) return false;
                if (endDate && expenseDate > endDate) return false;
                return true;
            });
            
            // Note: `expenses` from onSnapshot is already sorted by createdAt
            
            expensesTotalLabel.textContent = (startDate || endDate) ? 'Total Expenses (Filtered):' : 'Total Expenses (All Time):';

            if (filteredExpenses.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="text-center p-6 text-gray-500">${(startDate || endDate) ? 'No expenses found for this date range.' : 'No expenses logged yet.'}</td>`;
                expensesTableBody.appendChild(tr);
            } else {
                filteredExpenses.forEach(expense => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';

                    const expenseDate = expense.dateTime.toDate();
                    const dateString = expenseDate.toLocaleDateString('en-IN', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });
                    const timeString = expenseDate.toLocaleTimeString('en-IN', {
                        hour: '2-digit', minute: '2-digit', hour12: true
                    });

                    tr.innerHTML = `
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-700">
                            <div>${dateString}</div>
                            <div class="text-xs text-gray-500">${timeString}</div>
                        </td>
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-900 font-medium">${expense.productName}</td>
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-700">${expense.quantity || 'N/A'}</td>
                        <td class="py-4 px-4 sm:px-6 text-sm text-gray-900 font-semibold">₹${expense.price.toFixed(2)}</td>
                        <td class="py-4 px-4 sm:px-6 text-sm">
                            <button class="edit-expense-btn text-blue-600 hover:text-blue-800 font-medium" data-id="${expense.id}">Edit</button>
                            <button class="delete-expense-btn text-red-600 hover:text-red-800 font-medium ml-3" data-id="${expense.id}">Delete</button>
                        </td>
                    `;
                    expensesTableBody.appendChild(tr);

                    overallTotal += expense.price;
                });
            }
            
            expensesTotalDisplay.textContent = `₹${overallTotal.toFixed(2)}`;
        }

        expensesForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const productName = expensesProductName.value;
            const quantity = parseInt(expensesQuantity.value) || 0;
            const totalPrice = parseFloat(expensesTotalPrice.value) || 0;

            if (!productName) {
                showToast('Please enter a product or service name.', 'error');
                return;
            }
            if (totalPrice <= 0) {
                showToast('Please enter a valid total price.', 'error');
                return;
            }

            const newExpense = {
                dateTime: new Date(), // Will be converted to Timestamp
                productName: productName,
                quantity: quantity > 0 ? quantity : null,
                price: totalPrice
            };
            
            try {
                await addDoc(expensesCollection, newExpense);
                expensesForm.reset();
                showToast('Expense logged successfully!', 'success');
                // No need to re-render, onSnapshot will handle it.
            } catch (error) {
                console.error("Error logging expense: ", error);
                showToast('Error logging expense. Check console.', 'error');
            }
        });
        
        expensesTableBody.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-expense-btn');
            const deleteBtn = e.target.closest('.delete-expense-btn');

            if (editBtn) {
                const id = editBtn.dataset.id;
                openEditExpenseModal(id);
            }

            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                showConfirmationModal(
                    'Are you sure you want to delete this expense?',
                    () => deleteExpense(id)
                );
            }
        });
        
        // --- Edit Expense Modal Logic (UPDATED FOR FIREBASE) ---
        
        function openEditExpenseModal(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            currentEditExpenseId = id;
            editExpenseForm.reset();
            
            editExpenseProductName.value = expense.productName;
            editExpenseQuantity.value = expense.quantity || '';
            editExpenseTotalPrice.value = expense.price;
            
            editExpenseModal.classList.remove('hidden');
            editExpenseModal.classList.add('flex');
        }
        
        function closeEditExpenseModal() {
            currentEditExpenseId = null;
            editExpenseForm.reset();
            editExpenseModal.classList.add('hidden');
            editExpenseModal.classList.remove('flex');
        }
        
        editExpenseCancelBtn.addEventListener('click', closeEditExpenseModal);
        editExpenseModal.addEventListener('click', function(e) {
            if (e.target === editExpenseModal) closeEditExpenseModal();
        });
        
        editExpenseForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditExpenseId) return;

            const productName = editExpenseProductName.value;
            const quantity = parseInt(editExpenseQuantity.value) || 0;
            const totalPrice = parseFloat(editExpenseTotalPrice.value) || 0;

            if (!productName) {
                showToast('Please enter a product or service name.', 'error');
                return;
            }
            if (totalPrice <= 0) {
                showToast('Please enter a valid total price.', 'error');
                return;
            }
            
            const expenseRef = doc(expensesCollection, currentEditExpenseId);
            try {
                await updateDoc(expenseRef, {
                    productName: productName,
                    quantity: quantity > 0 ? quantity : null,
                    price: totalPrice
                });
                closeEditExpenseModal();
                showToast('Expense updated successfully!', 'success');
                // No need to re-render, onSnapshot will handle it.
            } catch (error) {
                console.error("Error updating expense: ", error);
                showToast('Error updating expense. Check console.', 'error');
            }
        });

        async function deleteExpense(id) {
            try {
                await deleteDoc(doc(expensesCollection, id));
                showToast('Expense deleted successfully.', 'success');
                // No need to re-render, onSnapshot will handle it.
            } catch (error) {
                console.error("Error deleting expense: ", error);
                showToast('Error deleting expense.', 'error');
            } finally {
                hideConfirmationModal();
            }
        }

        // --- Confirmation Modal Logic (NO CHANGE) ---
        
        function showConfirmationModal(message, callback) {
            confirmationMessage.textContent = message;
            confirmCallback = callback;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }
        
        function hideConfirmationModal() {
            confirmCallback = null;
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }
        
        confirmationCancelBtn.addEventListener('click', hideConfirmationModal);
        confirmationModal.addEventListener('click', function(e) {
            if (e.target === confirmationModal) hideConfirmationModal();
        });
        
        confirmationConfirmBtn.addEventListener('click', function() {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
        });


        // --- Analysis Page Logic (UPDATED FOR FIREBASE) ---
        function populateAnalysisDropdown() {
            analysisProductSelect.innerHTML = '';
            const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));

            if (sortedProducts.length === 0) {
                analysisProductSelect.innerHTML = '<option disabled selected>No products available</option>';
            } else {
                sortedProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id; // Use Firestore ID
                    option.textContent = `${product.name} (SKU: ${product.sku})`;
                    analysisProductSelect.appendChild(option);
                });
            }
        }

        function updateAnalysis() {
            const selectedProductId = analysisProductSelect.value;
            const startDate = analysisStartDate.value;
            const endDate = analysisEndDate.value;
            
            const product = products.find(p => p.id === selectedProductId);

            let filteredHistory = [];
            if (product) {
                filteredHistory = product.salesHistory.filter(entry => {
                    const entryDate = entry.dateTime.toDate().toISOString().split('T')[0];
                    if (startDate && entryDate < startDate) return false;
                    if (endDate && entryDate > endDate) return false;
                    return true;
                });
            }
            
            renderSalesChart(product, filteredHistory);
            renderSalesPieChart(startDate, endDate);
            updateAnalysisSummary(filteredHistory);
        }

        function updateAnalysisSummary(filteredHistory) {
            const total = filteredHistory.reduce((sum, entry) => sum + entry.quantity, 0);
            analysisTotalSold.textContent = `${total} units`;
        }


        function renderSalesChart(product, filteredHistory) {
            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            const ctx = salesChartCanvas.getContext('2d');
            if (!product || filteredHistory.length === 0) {
                ctx.clearRect(0, 0, salesChartCanvas.width, salesChartCanvas.height);
                ctx.save();
                ctx.textAlign = 'center';
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.fillText(product ? 'No sales data for this date range.' : 'Please select a product.', salesChartCanvas.width / 2, salesChartCanvas.height / 2);
                ctx.restore();
                return;
            }
            
            // Group sales by date
            const salesByDate = {};
            filteredHistory.forEach(entry => {
                const date = entry.dateTime.toDate().toISOString().split('T')[0];
                salesByDate[date] = (salesByDate[date] || 0) + entry.quantity;
            });
            
            const sortedDates = Object.keys(salesByDate).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates;
            const data = sortedDates.map(date => salesByDate[date]);

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Sales',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Units Sold' } }, x: { title: { display: true, text: 'Date' } } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false, },
                        title: { display: true, text: `Sales History for ${product.name}`, font: { size: 18 } }
                    }
                }
            });
        }
        
        function renderSalesPieChart(startDate, endDate) {
            if (salesPieChartInstance) {
                salesPieChartInstance.destroy();
            }

            const salesByProduct = products.map(product => {
                const total = product.salesHistory
                    .filter(sale => {
                        const saleDate = sale.dateTime.toDate().toISOString().split('T')[0];
                        if (startDate && saleDate < startDate) return false;
                        if (endDate && saleDate > endDate) return false;
                        return true;
                    })
                    .reduce((sum, sale) => sum + sale.quantity, 0);
                
                return { name: product.name, total: total };
            }).filter(p => p.total > 0);
            
            const ctx = salesPieChartCanvas.getContext('2d');
            if (salesByProduct.length === 0) {
                ctx.clearRect(0, 0, salesPieChartCanvas.width, salesPieChartCanvas.height);
                ctx.save();
                ctx.textAlign = 'center';
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.fillText('No sales data for any product in this range.', salesPieChartCanvas.width / 2, salesPieChartCanvas.height / 2);
                ctx.restore();
                return;
            }

            const labels = salesByProduct.map(p => p.name);
            const data = salesByProduct.map(p => p.total);
            const colors = labels.map((_, i) => `hsl(${(i * 360 / labels.length) % 360}, 70%, 60%)`);

            salesPieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Units Sold',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${label}: ${value} units (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Toast Notification Utility (NO CHANGE) ---
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.classList.remove('bg-green-600', 'bg-red-600');
            toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600', 'text-white');
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // --- Calculator Page Logic (NO CHANGE) ---
        function calculateShipping(weight_g) {
            if (weight_g <= 0) return 0.00;
            if (weight_g <= 500) return 76.70;
            if (weight_g <= 1000) return 100.30;
            if (weight_g <= 2000) return 143.96;
            if (weight_g <= 3000) return 184.08;
            if (weight_g <= 4000) return 224.20;
            if (weight_g <= 5000) return 264.32;
            if (weight_g <= 6000) return 285.56;
            if (weight_g <= 7000) return 306.80;
            if (weight_g <= 8000) return 328.04;
            if (weight_g <= 9000) return 349.28;
            if (weight_g <= 10000) return 370.52;
            return 370.52; 
        }
        productWeightEl.addEventListener('input', function() {
            const weight = parseFloat(productWeightEl.value) || 0;
            const shipping = calculateShipping(weight);
            shippingCostEl.value = shipping.toFixed(2);
        });
        calculatorForm.addEventListener('submit', function(event) {
            event.preventDefault();
            // This is a self-contained form, so we can get elements locally
            const sellingPriceEl = document.getElementById('selling-price');
            const productCostEl = document.getElementById('product-cost');
            const packagingCostEl = document.getElementById('packaging-cost');
            const amazonFeesEl = document.getElementById('amazon-fees');
            const gstPercentageEl = document.getElementById('gst-percentage');
            const otherCostsEl = document.getElementById('other-costs');
            const resultsContainer = document.getElementById('results-container');
            const totalCostEl = document.getElementById('total-cost');
            const netProfitBeforeTaxEl = document.getElementById('net-profit-before-tax');
            const profitMarginEl = document.getElementById('profit-margin');
            const taxAmountEl = document.getElementById('tax-amount');
            const netProfitAfterTaxEl = document.getElementById('net-profit-after-tax');
            const roiEl = document.getElementById('roi');
            const sellingPrice = parseFloat(sellingPriceEl.value) || 0;
            const productCost = parseFloat(productCostEl.value) || 0;
            const shippingCost = parseFloat(shippingCostEl.value) || 0;
            const packagingCost = parseFloat(packagingCostEl.value) || 0;
            const amazonFees = parseFloat(amazonFeesEl.value) || 0;
            const gstPercentage = parseFloat(gstPercentageEl.value) || 0;
            const otherCosts = parseFloat(otherCostsEl.value) || 0;
            const totalCost = productCost + shippingCost + packagingCost + amazonFees + otherCosts;
            const netProfitBeforeTax = sellingPrice - totalCost;
            const profitMargin = sellingPrice > 0 ? (netProfitBeforeTax / sellingPrice) * 100 : 0;
            const taxAmount = (sellingPrice * gstPercentage) / 100;
            const netProfitAfterTax = netProfitBeforeTax - taxAmount;
            const roi = productCost > 0 ? (netProfitAfterTax / productCost) * 100 : 0;
            totalCostEl.textContent = `₹${totalCost.toFixed(2)}`;
            netProfitBeforeTaxEl.textContent = `₹${netProfitBeforeTax.toFixed(2)}`;
            profitMarginEl.textContent = `${profitMargin.toFixed(2)}%`;
            taxAmountEl.textContent = `₹${taxAmount.toFixed(2)}`;
            netProfitAfterTaxEl.textContent = `₹${netProfitAfterTax.toFixed(2)}`;
            roiEl.textContent = `${roi.toFixed(2)}%`;
            netProfitAfterTaxEl.parentElement.classList.remove('bg-green-50', 'bg-red-50', 'bg-gray-50');
            netProfitAfterTaxEl.classList.remove('text-green-700', 'text-red-700', 'text-gray-800');
            if (netProfitAfterTax > 0) {
                netProfitAfterTaxEl.parentElement.classList.add('bg-green-50');
                netProfitAfterTaxEl.classList.add('text-green-700');
            } else if (netProfitAfterTax < 0) {
                netProfitAfterTaxEl.parentElement.classList.add('bg-red-50');
                netProfitAfterTaxEl.classList.add('text-red-700');
            } else {
                netProfitAfterTaxEl.parentElement.classList.add('bg-gray-50');
                netProfitAfterTaxEl.classList.add('text-gray-800');
            }
            resultsContainer.classList.remove('hidden');
        });

        // --- NEW: Initial App Load & Firebase Auth ---
        
        /**
         * Attaches all real-time listeners to Firestore.
         */
        function attachFirestoreListeners() {
            // Define collection paths
            // UPDATED: Removed /artifacts/${appId}
            productsCollection = collection(db, `/users/${userId}/products`);
            expensesCollection = collection(db, `/users/${userId}/expenses`);

            // --- Product Listener ---
            const productsQuery = query(productsCollection); // Add orderBy if needed, e.g., orderBy("createdAt", "desc")
            onSnapshot(productsQuery, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update all UI elements that depend on the product list
                renderDashboard();
                populateInventoryDropdown();
                populateAnalysisDropdown();
                populateProfitSetDropdown();
                
                // Re-render pages if they are active
                if (!pageRevenue.classList.contains('hidden')) renderRevenuePage();
                if (!pageAnalysis.classList.contains('hidden')) updateAnalysis();

            }, (error) => {
                console.error("Error listening to products: ", error);
                showToast('Error loading products. See console.', 'error');
            });

            // --- Expenses Listener ---
            const expensesQuery = query(expensesCollection); // Add orderBy if needed
            onSnapshot(expensesQuery, (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort by date (newest first)
                expenses.sort((a, b) => b.dateTime.toDate() - a.dateTime.toDate());

                // Re-render if active
                if (!pageExpenses.classList.contains('hidden')) renderExpensesPage();

            }, (error) => {
                console.error("Error listening to expenses: ", error);
                showToast('Error loading expenses. See console.', 'error');
            });
        }
        

        /**
         * Initializes the entire application.
         */
        async function main() {
            try {
                // 1. Get Firebase Config
                // UPDATED: User-provided config
                const firebaseConfig = {
                  apiKey: "AIzaSyBEsOx3JPO9ujMXfXHrpFmI8Q0LOIh4iH0",
                  authDomain: "dashboard-5fc47.firebaseapp.com",
                  projectId: "dashboard-5fc47",
                  storageBucket: "dashboard-5fc47.firebasestorage.app",
                  messagingSenderId: "354665141955",
                  appId: "1:354665141955:web:f6228f8477696c27307476",
                  measurementId: "G-ZHYK1BZ0WW"
                };

                // 2. Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 3. Set up Auth Listener
                onAuthStateChanged(auth, (user) => {
                    if (user && !isAuthReady) {
                        console.log('User is signed in:', user.uid);
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // User is ready, attach data listeners
                        attachFirestoreListeners();
                        
                        // Set the default page
                        // UPDATED: Default to dashboard
                        setActivePage('dashboard'); 
                        
                        // Hide loading overlay
                        loadingOverlay.style.display = 'none';
                        
                        // Set initial lock state
                        updateLockIcons();
                    }
                });

                // 4. Sign In
                // UPDATED: Sign in anonymously as no token is provided
                console.log('Signing in anonymously...');
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Fatal: Firebase initialization failed.", error);
                loadingOverlay.innerHTML = `<p class="text-red-600">Error: Could not connect to database. ${error.message}</p>`;
            }
        }

        // Run the app
        main();

    </script>
</body>
</html>
